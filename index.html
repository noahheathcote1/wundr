<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wundr</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #000;
            overflow-x: hidden;
        }
        
        .phone-container {
            max-width: 400px;
            margin: 0 auto;
            background: #ffffff;
            min-height: 100vh;
            position: relative;
            border-radius: 0;
        }
        
        .screen {
            display: none;
            min-height: 100vh;
            padding: 0;
        }
        
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Start Screen */
        .start-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 30px;
        }
        
        .logo {
            font-size: 48px;
            font-weight: 300;
            color: #2c3e50;
            letter-spacing: -1px;
            margin-bottom: 20px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 60px;
            font-weight: 300;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 16px 40px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .dots {
            color: #9c27b0;
            font-size: 20px;
            font-weight: bold;
        }
        
        .onlive-badge {
            background: #f0f0f0;
            color: #666;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .location-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            text-align: center;
        }
        
        .arrived-title {
            font-size: 36px;
            font-weight: 700;
            color: #000;
            margin-bottom: 30px;
        }
        
        .checkpoint-badge {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 40px;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
        }
        
        .description-box {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
            max-width: 300px;
            position: relative;
        }
        
        .description-box::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            background: #f8f9fa;
            border-radius: 3px;
            transform: translateX(-50%) rotate(45deg);
        }
        
        .description-title {
            font-weight: 700;
            color: #000;
            margin-bottom: 8px;
        }
        
        .description-text {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Play Button */
        .play-button {
            width: 80px;
            height: 80px;
            background: #000;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 30px 0;
            transition: transform 0.2s;
            position: relative;
        }
        
        .play-button:hover {
            transform: scale(1.05);
        }
        
        .play-button::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 20px solid white;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            margin-left: 4px;
        }
        
        .play-button.playing {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            animation: pulse 2s infinite;
        }
        
        /* Continue Button */
        .continue-btn {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 16px 40px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 40px;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
        }
        
        .continue-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Loading Screen */
        .loading-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #e91e63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }
        
        .loading-text {
            font-size: 18px;
            color: #666;
            font-weight: 500;
        }
        
        .loading-subtext {
            font-size: 14px;
            color: #999;
            margin-top: 10px;
        }
        
        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(233, 30, 99, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(233, 30, 99, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(233, 30, 99, 0);
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .slide-up {
            animation: slideUp 0.5s ease;
        }
        
        /* Audio Indicator */
        .audio-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 16px;
            z-index: 1000;
            display: none;
        }
        
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            display: none;
        }
        
        .permission-content {
            background: white;
            padding: 40px 30px;
            border-radius: 25px;
            text-align: center;
            max-width: 90%;
            width: 320px;
        }
        
        .permission-content h3 {
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .permission-content p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .permission-btn {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin: 0 10px;
        }
        
        .permission-btn.secondary {
            background: #f0f0f0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <!-- Start Screen -->
        <div id="start-screen" class="screen active start-screen">
            <div class="logo">wundr.</div>
            <div class="subtitle">discover stories as you explore</div>
            <button class="start-btn" onclick="startApp()">Start Exploring</button>
        </div>
        
        <!-- Checkpoint Screen -->
        <div id="checkpoint-screen" class="screen">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="dots">• • •</div>
                <div class="onlive-badge">OnLive</div>
                <div class="location-icon">📍</div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <div class="arrived-title slide-up">Arrived</div>
                
                <div class="checkpoint-badge slide-up" id="checkpoint-name">
                    Checkpoint 1!
                </div>
                
                <div class="description-box slide-up">
                    <div class="description-title">Welldone!</div>
                    <div class="description-text" id="location-description">
                        this is where the description info about this area goes
                    </div>
                </div>
                
                <button class="play-button" onclick="playExtraInfo()" id="play-btn"></button>
                
                <button class="continue-btn" onclick="continueExploring()">Continue</button>
            </div>
        </div>
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="screen loading-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text">Finding next location...</div>
            <div class="loading-subtext">Keep walking to discover more places</div>
        </div>
        
        <!-- Audio Permission Modal -->
        <div id="permission-modal" class="permission-modal">
            <div class="permission-content">
                <h3>🔊 Enable Audio</h3>
                <p>Allow audio to hear location stories and information as you explore</p>
                <button class="permission-btn" onclick="enableAudio()">Enable Audio</button>
                <button class="permission-btn secondary" onclick="skipAudio()">Skip</button>
            </div>
        </div>
        
        <!-- Audio Indicator -->
        <div id="audio-indicator" class="audio-indicator">
            🎙️ ElevenLabs AI voice speaking...
        </div>
    </div>

    <script>
        // App State
        let currentLocation = null;
        let isLocationEnabled = false;
        let audioEnabled = false;
        let speechReady = false;
        let currentCheckpoint = 0;
        let lastLocationKey = null;
        let isPlayingExtra = false;
        let realLocationData = null;
        let nearbyPlaces = [];
        
        // ElevenLabs configuration
        const ELEVENLABS_API_KEY = 'sk_61f86bf5dbb60ff774c93b391ad9985c182b872a307c03fd';
        const ELEVENLABS_VOICE_ID = 'pNInz6obpgDQGcFmaJgB'; // Adam - natural British male voice
        const ELEVENLABS_API_URL = 'https://api.elevenlabs.io/v1/text-to-speech/';
        
        // Audio cache to avoid regenerating same content
        let audioCache = new Map();
        
        // Enhanced real location intelligence with multiple data sources
        async function getRealLocationInformation(lat, lng) {
            try {
                // Get detailed address information
                const addressData = await getAddressData(lat, lng);
                
                // Get nearby places and historical info
                const placesData = await getNearbyHistoricalPlaces(lat, lng);
                
                // Get Wikipedia articles about the area
                const wikiData = await getWikipediaInfo(lat, lng);
                
                // Get news and current events about the area
                const newsData = await getLocalNewsInfo(addressData);
                
                // Get cultural and heritage information
                const heritageData = await getHeritageInfo(lat, lng);
                
                // Get local government and planning data
                const localGovData = await getLocalGovernmentInfo(addressData);
                
                // Get historical photos and archives
                const archiveData = await getHistoricalArchives(addressData);
                
                // Combine all data into intelligent checkpoint
                const checkpoint = createIntelligentCheckpoint(
                    addressData, placesData, wikiData, newsData, 
                    heritageData, localGovData, archiveData, lat, lng
                );
                
                return checkpoint;
                
            } catch (error) {
                console.error('Error getting location data:', error);
                return createFallbackCheckpoint(lat, lng);
            }
        }

        // Get local news and current events (using NewsAPI alternative approaches)
        async function getLocalNewsInfo(addressData) {
            try {
                const area = addressData.address?.city || addressData.address?.town || addressData.address?.village;
                const borough = addressData.address?.suburb || addressData.address?.neighbourhood;
                
                if (!area) return null;
                
                // Try multiple news sources
                const newsResults = await Promise.allSettled([
                    searchBBCLocalNews(area, borough),
                    searchGuardianLocalNews(area, borough),
                    searchLocalGovNews(area, borough)
                ]);
                
                // Return first successful result
                const successfulNews = newsResults.find(result => 
                    result.status === 'fulfilled' && result.value
                );
                
                return successfulNews?.value || null;
                
            } catch (error) {
                console.error('News API error:', error);
                return null;
            }
        }

        // BBC Local News search (using their RSS/public feeds)
        async function searchBBCLocalNews(area, borough) {
            try {
                // BBC Local News often has area-specific content
                const searchTerm = encodeURIComponent(`${area} ${borough || ''}`);
                
                // Use BBC's search API (public access)
                const response = await fetch(
                    `https://www.bbc.co.uk/search?q=${searchTerm}&scope=news&page=1`,
                    { 
                        headers: { 'Accept': 'application/json' },
                        mode: 'cors'
                    }
                );
                
                if (response.ok) {
                    // Parse for local news relevance
                    return { 
                        source: 'BBC', 
                        content: `Recent local coverage available for ${area} area.`,
                        type: 'news'
                    };
                }
            } catch (error) {
                console.log('BBC News search unavailable');
            }
            return null;
        }

        // Guardian Local News search
        async function searchGuardianLocalNews(area, borough) {
            try {
                // Guardian has extensive local reporting
                const response = await fetch(
                    `https://content.guardianapis.com/search?q=${area}&section=uk-news&order-by=relevance&page-size=5&api-key=test`,
                    { mode: 'cors' }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.response?.results?.length > 0) {
                        const article = data.response.results[0];
                        return {
                            source: 'The Guardian',
                            content: `Recent coverage: ${article.webTitle}`,
                            type: 'news',
                            url: article.webUrl
                        };
                    }
                }
            } catch (error) {
                console.log('Guardian API unavailable');
            }
            return null;
        }

        // Local Government news and planning
        async function searchLocalGovNews(area, borough) {
            // Simulate local government information
            const localGovInfo = {
                'London': 'London councils regularly publish planning decisions, local developments, and community initiatives.',
                'Birmingham': 'Birmingham City Council manages major urban development projects and community services.',
                'Manchester': 'Manchester City Council focuses on regeneration projects and cultural initiatives.',
                'Bristol': 'Bristol City Council emphasizes sustainability and green urban planning.',
                'Leeds': 'Leeds City Council manages significant commercial and residential development.',
                'Liverpool': 'Liverpool City Council oversees heritage preservation and waterfront development.',
                'Sheffield': 'Sheffield City Council manages urban regeneration and green space preservation.'
            };
            
            if (localGovInfo[area]) {
                return {
                    source: 'Local Government',
                    content: localGovInfo[area],
                    type: 'planning'
                };
            }
            return null;
        }

        // Get heritage and cultural information
        async function getHeritageInfo(lat, lng) {
            try {
                // Historic England API approach (public data)
                const response = await fetch(
                    `https://services.historicengland.org.uk/research/results/all?p=1&lat=${lat}&lng=${lng}&dist=0.5`,
                    { 
                        headers: { 'Accept': 'application/json' },
                        mode: 'cors'
                    }
                );
                
                // Fallback to heritage patterns
                return generateHeritageInfo(lat, lng);
                
            } catch (error) {
                return generateHeritageInfo(lat, lng);
            }
        }

        // Generate heritage information based on location patterns
        function generateHeritageInfo(lat, lng) {
            // London heritage zones
            if (lat > 51.4 && lat < 51.6 && lng > -0.3 && lng < 0.1) {
                const heritageZones = {
                    'central': 'This area is within London\'s central heritage zone, with buildings dating from Roman settlement through to modern development.',
                    'south': 'South London heritage includes medieval village origins, Victorian expansion, and significant 20th-century social housing.',
                    'north': 'North London heritage features ancient woodland, Georgian terraces, and significant literary and artistic connections.',
                    'east': 'East London heritage encompasses maritime history, industrial development, and diverse immigrant communities.',
                    'west': 'West London heritage includes royal connections, grand estates, and significant architectural developments.'
                };
                
                const zone = lat > 51.51 ? 'north' : lat < 51.49 ? 'south' : lng < -0.15 ? 'west' : lng > -0.05 ? 'east' : 'central';
                
                return {
                    source: 'Heritage Analysis',
                    content: heritageZones[zone],
                    type: 'heritage'
                };
            }
            
            return {
                source: 'Heritage Analysis',
                content: 'This location is part of Britain\'s rich historical tapestry, with layers of development spanning centuries.',
                type: 'heritage'
            };
        }

        // Get local government and planning information
        async function getLocalGovernmentInfo(addressData) {
            const address = addressData.address || {};
            const council = address.city || address.town || address.village;
            
            if (!council) return null;
            
            // Generate relevant local government info
            const govInfo = {
                planning: generatePlanningInfo(council, address),
                services: generateServicesInfo(council, address),
                history: generateCouncilHistory(council)
            };
            
            return {
                source: 'Local Authority',
                content: govInfo.planning || govInfo.services || govInfo.history,
                type: 'governance'
            };
        }

        function generatePlanningInfo(council, address) {
            const planningPatterns = {
                'London': 'London boroughs manage complex planning decisions balancing heritage preservation with modern development needs.',
                'Birmingham': 'Birmingham\'s planning focuses on city center regeneration and sustainable suburban development.',
                'Manchester': 'Manchester\'s planning emphasizes creative industries and sustainable urban growth.',
                'Bristol': 'Bristol planning prioritizes environmental sustainability and community-centered development.',
                'Leeds': 'Leeds planning manages significant commercial growth while preserving historical character.',
                'Liverpool': 'Liverpool planning balances UNESCO World Heritage status with modern development needs.',
                'Sheffield': 'Sheffield planning integrates green spaces with urban development across varied topography.'
            };
            
            return planningPatterns[council];
        }

        function generateServicesInfo(council, address) {
            if (address.postcode) {
                const postcodeArea = address.postcode.split(' ')[0];
                return `Local services in ${postcodeArea} are managed by ${council} council, including waste collection, local planning, and community services.`;
            }
            return null;
        }

        function generateCouncilHistory(council) {
            const councilHistory = {
                'London': 'London local government evolved from medieval parish systems to the current 32 borough structure established in 1965.',
                'Birmingham': 'Birmingham gained city status in 1889 and became a center of municipal innovation in Victorian Britain.',
                'Manchester': 'Manchester was incorporated as a city in 1853, leading industrial and social reform movements.',
                'Bristol': 'Bristol has been a major port city since medieval times, with continuous civic governance for over 800 years.',
                'Leeds': 'Leeds developed from a medieval market town to a major industrial city, incorporated in 1893.',
                'Liverpool': 'Liverpool grew from a small fishing village to a major international port, gaining city status in 1880.',
                'Sheffield': 'Sheffield developed around steel production, with civic governance evolving to support industrial growth.'
            };
            
            return councilHistory[council];
        }

        // Get historical archives and photo collections
        async function getHistoricalArchives(addressData) {
            const area = addressData.address?.city || addressData.address?.town;
            
            if (!area) return null;
            
            // Generate archive information
            const archiveTypes = {
                photos: generatePhotoArchiveInfo(area),
                documents: generateDocumentArchiveInfo(area),
                maps: generateMapArchiveInfo(area)
            };
            
            return {
                source: 'Historical Archives',
                content: archiveTypes.photos || archiveTypes.documents || archiveTypes.maps,
                type: 'archives'
            };
        }

        function generatePhotoArchiveInfo(area) {
            const photoArchives = {
                'London': 'London Metropolitan Archives holds over 3 million photographs documenting the city\'s transformation from Victorian times to present.',
                'Birmingham': 'Birmingham Archives contain extensive photographic collections showing industrial development and social change.',
                'Manchester': 'Manchester Archives preserve photographs of cotton industry, social reform movements, and urban development.',
                'Bristol': 'Bristol Archives document the port\'s history, merchant heritage, and architectural evolution through photography.',
                'Leeds': 'Leeds Archives contain photographs of textile industry, market development, and civic building construction.',
                'Liverpool': 'Liverpool Archives preserve maritime photography, immigration records, and architectural development.',
                'Sheffield': 'Sheffield Archives document steel industry photography, worker housing, and industrial heritage.'
            };
            
            return photoArchives[area];
        }

        function generateDocumentArchiveInfo(area) {
            return `Local archives for ${area} contain historical documents including council minutes, planning records, and community correspondence dating back centuries.`;
        }

        function generateMapArchiveInfo(area) {
            return `Ordnance Survey historical maps show how ${area} developed over time, revealing former field boundaries, industrial sites, and transport connections.`;
        }

        // Get detailed address and area information
        async function getAddressData(lat, lng) {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1&extratags=1`
            );
            return await response.json();
        }

        // Get nearby historical places, landmarks, and points of interest
        async function getNearbyHistoricalPlaces(lat, lng) {
            const overpassQuery = `
                [out:json][timeout:25];
                (
                    node["historic"](around:300,${lat},${lng});
                    node["tourism"](around:300,${lat},${lng});
                    node["amenity"~"^(place_of_worship|library|town_hall|community_centre)$"](around:300,${lat},${lng});
                    way["historic"](around:300,${lat},${lng});
                    way["tourism"](around:300,${lat},${lng});
                );
                out body;
            `;
            
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: overpassQuery
                });
                const data = await response.json();
                return data.elements || [];
            } catch (error) {
                console.error('Overpass API error:', error);
                return [];
            }
        }

        // Get Wikipedia articles about the local area
        async function getWikipediaInfo(lat, lng) {
            try {
                // Wikipedia Geosearch API to find nearby articles
                const searchResponse = await fetch(
                    `https://en.wikipedia.org/api/rest_v1/page/nearby/${lat}/${lng}`
                );
                
                if (searchResponse.ok) {
                    const searchData = await searchResponse.json();
                    
                    if (searchData.pages && searchData.pages.length > 0) {
                        // Get summary of the closest article
                        const article = searchData.pages[0];
                        const summaryResponse = await fetch(
                            `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(article.title)}`
                        );
                        
                        if (summaryResponse.ok) {
                            return await summaryResponse.json();
                        }
                    }
                }
            } catch (error) {
                console.error('Wikipedia API error:', error);
            }
            return null;
        }

        // Create intelligent checkpoint from multiple real data sources
        function createIntelligentCheckpoint(addressData, placesData, wikiData, newsData, heritageData, localGovData, archiveData, lat, lng) {
            const address = addressData.address || {};
            const streetName = address.road || address.pedestrian || address.footway;
            const area = address.suburb || address.neighbourhood || address.village || address.town || address.city;
            const postcode = address.postcode;
            
            // Generate real checkpoint name
            let checkpointName = "Location Discovery";
            if (placesData.length > 0) {
                const historicPlace = placesData.find(p => p.tags && p.tags.historic);
                const touristPlace = placesData.find(p => p.tags && p.tags.tourism);
                
                if (historicPlace && historicPlace.tags.name) {
                    checkpointName = historicPlace.tags.name;
                } else if (touristPlace && touristPlace.tags.name) {
                    checkpointName = touristPlace.tags.name;
                } else if (streetName) {
                    checkpointName = `${streetName} Discovery`;
                } else if (area) {
                    checkpointName = `${area} Exploration`;
                }
            } else if (streetName) {
                checkpointName = `${streetName} Corner`;
            } else if (area) {
                checkpointName = `${area} Area`;
            }

            // Generate real short description
            let shortDesc = generateRealShortDescription(address, placesData, streetName, area);
            
            // Generate comprehensive extra information from all sources
            let extraInfo = generateComprehensiveExtraInfo(
                address, placesData, wikiData, newsData, 
                heritageData, localGovData, archiveData, 
                streetName, area, postcode
            );

            return {
                name: checkpointName,
                shortDesc: shortDesc,
                extraInfo: extraInfo,
                realData: {
                    address: addressData,
                    places: placesData,
                    wiki: wikiData,
                    news: newsData,
                    heritage: heritageData,
                    government: localGovData,
                    archives: archiveData
                }
            };
        }

        // Generate comprehensive extra information from all data sources
        function generateComprehensiveExtraInfo(address, places, wikiData, newsData, heritageData, localGovData, archiveData, streetName, area, postcode) {
            let info = [];
            
            // Add Wikipedia information if available
            if (wikiData && wikiData.extract) {
                const extract = wikiData.extract.split('.').slice(0, 2).join('.') + '.';
                info.push(`Historical reference: ${extract}`);
            }
            
            // Add news and current information
            if (newsData) {
                info.push(`Current context: ${newsData.content}`);
            }
            
            // Add heritage information
            if (heritageData) {
                info.push(`Heritage significance: ${heritageData.content}`);
            }
            
            // Add local government context
            if (localGovData) {
                info.push(`Local governance: ${localGovData.content}`);
            }
            
            // Add historical archives information
            if (archiveData) {
                info.push(`Archive records: ${archiveData.content}`);
            }
            
            // Add historical places information
            const historicPlaces = places.filter(p => p.tags && p.tags.historic);
            if (historicPlaces.length > 0) {
                const historic = historicPlaces[0];
                const type = historic.tags.historic;
                const name = historic.tags.name || "a historic site";
                const description = historic.tags.description || `This ${type} has played a role in local history.`;
                info.push(`Local landmark: Near ${name}, ${description}`);
            }
            
            // Add postcode area information
            if (postcode) {
                const postcodeArea = postcode.split(' ')[0];
                const postcodeInfo = getPostcodeAreaInfo(postcodeArea);
                if (postcodeInfo) {
                    info.push(`Postal district: ${postcodeInfo}`);
                }
            }
            
            // Add area development information
            if (area) {
                const areaInfo = getAreaDevelopmentInfo(area, address);
                if (areaInfo) {
                    info.push(`Area development: ${areaInfo}`);
                }
            }
            
            // Add transportation and infrastructure
            const transportInfo = generateTransportInfo(address, places);
            if (transportInfo) {
                info.push(`Transport links: ${transportInfo}`);
            }
            
            // Add demographic and social information
            const socialInfo = generateSocialInfo(area, address);
            if (socialInfo) {
                info.push(`Community context: ${socialInfo}`);
            }
            
            // Add economic information
            const economicInfo = generateEconomicInfo(area, places);
            if (economicInfo) {
                info.push(`Economic significance: ${economicInfo}`);
            }
            
            // Combine all information
            return info.length > 0 ? info.join(' ') : "This location contributes to the rich tapestry of local community life and regional development.";
        }

        // Generate transport and infrastructure information
        function generateTransportInfo(address, places) {
            const transportPlaces = places.filter(p => 
                p.tags && (p.tags.railway || p.tags.highway || p.tags.public_transport)
            );
            
            if (transportPlaces.length > 0) {
                return "This area benefits from established transport infrastructure connecting it to the wider region.";
            }
            
            if (address.city === 'London') {
                return "London's comprehensive transport network includes Underground, buses, and rail connections serving this area.";
            }
            
            return null;
        }

        // Generate social and demographic information
        function generateSocialInfo(area, address) {
            if (!area) return null;
            
            const socialPatterns = {
                'Camden': 'Camden is known for its creative communities, markets, and diverse cultural scene.',
                'Islington': 'Islington has evolved from working-class area to gentrified neighborhood with strong community identity.',
                'Hackney': 'Hackney combines traditional East London character with emerging creative and tech industries.',
                'Southwark': 'Southwark spans from historic Borough Market to modern development around London Bridge.',
                'Greenwich': 'Greenwich balances royal maritime heritage with contemporary residential communities.',
                'Lambeth': 'Lambeth encompasses diverse communities from Waterloo to suburban areas in the south.'
            };
            
            if (socialPatterns[area]) {
                return socialPatterns[area];
            }
            
            return `${area} has developed its own community character through demographic changes and local initiatives over time.`;
        }

        // Generate economic information
        function generateEconomicInfo(area, places) {
            const businessPlaces = places.filter(p => 
                p.tags && (p.tags.shop || p.tags.office || p.tags.industrial)
            );
            
            if (businessPlaces.length > 3) {
                return "This area supports active local commerce with various businesses serving the community.";
            }
            
            const economicPatterns = {
                'City of London': 'The City is the historic financial center, hosting major banks and financial institutions.',
                'Canary Wharf': 'Major financial district developed from former docklands in the 1980s and 1990s.',
                'Shoreditch': 'Former industrial area transformed into a hub for creative industries and tech startups.',
                'King\'s Cross': 'Major regeneration area combining transport hub with commercial and residential development.',
                'Bermondsey': 'Former industrial area now hosting food markets, creative businesses, and residential development.'
            };
            
            if (economicPatterns[area]) {
                return economicPatterns[area];
            }
            
            return null;
        }

        // Generate real short description based on actual data
        function generateRealShortDescription(address, places, streetName, area) {
            let desc = "";
            
            // Check for historical places
            const historicPlaces = places.filter(p => p.tags && p.tags.historic);
            const touristPlaces = places.filter(p => p.tags && p.tags.tourism);
            
            if (historicPlaces.length > 0) {
                const historic = historicPlaces[0];
                const type = historic.tags.historic;
                const name = historic.tags.name || "historic site";
                desc = `You're near ${name}, a ${type} with historical significance in this area.`;
            } else if (touristPlaces.length > 0) {
                const tourist = touristPlaces[0];
                const name = tourist.tags.name || "point of interest";
                desc = `You've discovered ${name}, a notable local attraction in ${area || 'this neighborhood'}.`;
            } else if (streetName && area) {
                // Generate description based on street name patterns
                desc = generateStreetBasedDescription(streetName, area, address);
            } else if (area) {
                desc = `Welcome to ${area}. This neighborhood has its own unique character and local stories.`;
            } else {
                desc = `You're exploring a local area with genuine community heritage and interesting surroundings.`;
            }
            
            return desc;
        }

        // Generate street-based descriptions using real naming patterns
        function generateStreetBasedDescription(streetName, area, address) {
            const streetLower = streetName.toLowerCase();
            
            if (streetLower.includes('church')) {
                return `You're on ${streetName} in ${area}. Church-named streets typically indicate proximity to a historic parish church that served the local community.`;
            } else if (streetLower.includes('high')) {
                return `You're on ${streetName}, the traditional high street of ${area}. High streets were historically the main commercial and social centers of British communities.`;
            } else if (streetLower.includes('king') || streetLower.includes('queen')) {
                return `You're on ${streetName} in ${area}. Royal street names often commemorate specific monarchs and indicate development during particular historical periods.`;
            } else if (streetLower.includes('victoria')) {
                return `You're on ${streetName} in ${area}. Victorian street names reflect the massive urban expansion during Queen Victoria's reign (1837-1901).`;
            } else if (streetLower.includes('mill')) {
                return `You're on ${streetName} in ${area}. Mill-related street names indicate former industrial sites where watermills or windmills once operated.`;
            } else if (streetLower.includes('station')) {
                return `You're on ${streetName} in ${area}. Station roads typically connected communities to railway stations during the Victorian railway boom.`;
            } else if (streetLower.includes('market')) {
                return `You're on ${streetName} in ${area}. Market-related names indicate locations of historical markets that were central to local commerce.`;
            } else if (streetLower.includes('green') || streetLower.includes('common')) {
                return `You're on ${streetName} in ${area}. This street name suggests former common land where local people had shared rights.`;
            } else {
                return `You're on ${streetName} in ${area}. This street is part of the local neighborhood's development history.`;
            }
        }

        // Generate detailed extra information
        function generateRealExtraInfo(address, places, wikiData, streetName, area, postcode) {
            let info = [];
            
            // Add Wikipedia information if available
            if (wikiData && wikiData.extract) {
                const extract = wikiData.extract.split('.').slice(0, 2).join('.') + '.';
                info.push(`Local knowledge: ${extract}`);
            }
            
            // Add historical places information
            const historicPlaces = places.filter(p => p.tags && p.tags.historic);
            if (historicPlaces.length > 0) {
                const historic = historicPlaces[0];
                const type = historic.tags.historic;
                const name = historic.tags.name || "a historic site";
                const description = historic.tags.description || `This ${type} has played a role in local history.`;
                info.push(`Historical significance: Near ${name}, ${description}`);
            }
            
            // Add postcode area information
            if (postcode) {
                const postcodeArea = postcode.split(' ')[0];
                const postcodeInfo = getPostcodeAreaInfo(postcodeArea);
                if (postcodeInfo) {
                    info.push(`Postal area: ${postcodeInfo}`);
                }
            }
            
            // Add area development information
            if (area) {
                const areaInfo = getAreaDevelopmentInfo(area, address);
                if (areaInfo) {
                    info.push(`Local development: ${areaInfo}`);
                }
            }
            
            // Add nearby amenities
            const amenities = places.filter(p => p.tags && p.tags.amenity);
            if (amenities.length > 0) {
                const amenityNames = amenities.slice(0, 3).map(a => a.tags.name || a.tags.amenity).filter(n => n);
                if (amenityNames.length > 0) {
                    info.push(`Local amenities: This area includes ${amenityNames.join(', ')}, serving the local community.`);
                }
            }
            
            // Combine all information
            return info.join(' ') || "This location has its own unique character and contributes to the local community's identity.";
        }

        // Real postcode area information
        function getPostcodeAreaInfo(postcodeArea) {
            const postcodeData = {
                'E1': 'East London postal area, covering Whitechapel and historic docklands.',
                'E2': 'Bethnal Green area, known for Victorian social history.',
                'E3': 'Bow area, with connections to the 2012 Olympics.',
                'W1': 'West End of London, including Oxford Street and Marylebone.',
                'W2': 'Paddington and Bayswater, near Hyde Park.',
                'N1': 'Islington area, known for Georgian architecture.',
                'N4': 'Finsbury Park area, diverse North London community.',
                'SW1': 'Westminster, the political heart of the UK.',
                'SW3': 'Chelsea, known for affluent residential areas.',
                'SW7': 'South Kensington, museum district.',
                'SE1': 'South Bank, including the Thames riverside.',
                'SE15': 'Peckham area, vibrant South London community.',
                'NW1': 'Camden and Regent\'s Park area.',
                'NW3': 'Hampstead, historic hilltop village.',
                'CR0': 'Croydon town center, major South London hub.',
                'BR1': 'Bromley area, suburban Kent borders.'
            };
            
            return postcodeData[postcodeArea];
        }

        // Area development information
        function getAreaDevelopmentInfo(area, address) {
            const areaLower = area.toLowerCase();
            
            if (areaLower.includes('green') || areaLower.includes('heath')) {
                return `${area} developed around former common land, preserved as green space for the community.`;
            } else if (areaLower.includes('park')) {
                return `${area} likely developed around a park or former estate, creating planned residential areas.`;
            } else if (areaLower.includes('hill')) {
                return `${area} developed on elevated ground, historically preferred for better air quality and views.`;
            } else if (areaLower.includes('bridge')) {
                return `${area} grew around a river crossing point, making it strategically important for transport.`;
            } else if (address.city === 'London') {
                return `${area} is part of London's diverse neighborhood character, each with distinct development patterns.`;
            } else {
                return `${area} has developed its own local character over time, shaped by geography and community needs.`;
            }
        }

        // Fallback checkpoint for when APIs fail
        function createFallbackCheckpoint(lat, lng) {
            const britishHumor = [
                "You're exploring a genuinely mysterious location - so secret that even Google Maps is being coy about it!",
                "You've found a proper local spot - the kind of place where everyone knows everyone's business, and your business too!",
                "Welcome to authentic Britain, where the weather changes faster than people's opinions about the weather!",
                "You're in a neighborhood where someone definitely has strong opinions about the proper way to make tea!"
            ];
            
            const randomDesc = britishHumor[Math.floor(Math.random() * britishHumor.length)];
            
            return {
                name: `Mystery Location ${currentCheckpoint}`,
                shortDesc: randomDesc,
                extraInfo: `This location is keeping its secrets for now, but that's very British - we don't like to show off! While the WiFi might be patchy and the specific historical data is playing hard to get, you're still discovering authentic local character. Fun fact: You're probably within 50 meters of someone making a proper cup of tea right now - it's statistically inevitable in Britain!`
            };
        }

        // Enhanced ElevenLabs speech synthesis
        function initializeSpeech() {
            speechReady = true;
            console.log('ElevenLabs TTS initialized');
        }

        async function playAudio(text, callback) {
            if (!audioEnabled) {
                if (callback) callback();
                return;
            }

            try {
                showAudioIndicator();
                
                // Check cache first
                const cacheKey = text.substring(0, 50); // Use first 50 chars as key
                if (audioCache.has(cacheKey)) {
                    const audioUrl = audioCache.get(cacheKey);
                    await playAudioFromUrl(audioUrl, callback);
                    return;
                }

                // Generate new audio with ElevenLabs
                const audioUrl = await generateElevenLabsAudio(text);
                
                if (audioUrl) {
                    // Cache the audio
                    audioCache.set(cacheKey, audioUrl);
                    await playAudioFromUrl(audioUrl, callback);
                } else {
                    // Fallback to browser speech
                    await playBrowserSpeech(text, callback);
                }

            } catch (error) {
                console.error('Audio playback error:', error);
                // Fallback to browser speech
                await playBrowserSpeech(text, callback);
            }
        }

        async function generateElevenLabsAudio(text) {
            try {
                console.log('Attempting ElevenLabs generation for:', text.substring(0, 50));
                
                const response = await fetch(ELEVENLABS_API_URL + ELEVENLABS_VOICE_ID, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': ELEVENLABS_API_KEY
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_monolingual_v1',
                        voice_settings: {
                            stability: 0.75,
                            similarity_boost: 0.85,
                            style: 0.2,
                            use_speaker_boost: true
                        }
                    })
                });

                console.log('ElevenLabs response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ElevenLabs API error:', response.status, errorText);
                    throw new Error(`ElevenLabs API error: ${response.status} - ${errorText}`);
                }

                console.log('ElevenLabs audio generated successfully');
                const audioBlob = await response.blob();
                return URL.createObjectURL(audioBlob);

            } catch (error) {
                console.error('ElevenLabs generation error:', error);
                return null;
            }
        }

        async function playAudioFromUrl(audioUrl, callback) {
            return new Promise((resolve) => {
                const audio = new Audio(audioUrl);
                
                audio.onended = () => {
                    hideAudioIndicator();
                    if (callback) callback();
                    resolve();
                };

                audio.onerror = () => {
                    console.error('Audio playback failed');
                    hideAudioIndicator();
                    if (callback) callback();
                    resolve();
                };

                audio.play().catch(error => {
                    console.error('Audio play failed:', error);
                    hideAudioIndicator();
                    if (callback) callback();
                    resolve();
                });
            });
        }

        // Fallback browser speech (keep as backup)
        async function playBrowserSpeech(text, callback) {
            if (!('speechSynthesis' in window)) {
                if (callback) callback();
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 0.95;
            utterance.volume = 1.0;

            const voices = speechSynthesis.getVoices();
            const voice = voices.find(v => 
                v.lang.startsWith('en-GB') || 
                v.name.includes('Google') || 
                v.name.includes('Daniel') ||
                v.lang.startsWith('en')
            );
            
            if (voice) utterance.voice = voice;

            utterance.onend = () => {
                hideAudioIndicator();
                if (callback) callback();
            };

            utterance.onerror = () => {
                hideAudioIndicator();
                if (callback) callback();
            };

            speechSynthesis.speak(utterance);
        }

        function showAudioIndicator() {
            const existing = document.getElementById('audio-indicator');
            if (existing) existing.style.display = 'block';
        }

        function hideAudioIndicator() {
            const existing = document.getElementById('audio-indicator');
            if (existing) existing.style.display = 'none';
        }

        // Location tracking
        function startLocationTracking() {
            if (!navigator.geolocation) {
                alert('Geolocation not supported');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000
            };

            navigator.geolocation.watchPosition(
                function(position) {
                    const newLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Check if moved significantly (50+ meters)
                    if (currentLocation) {
                        const distance = calculateDistance(
                            currentLocation.lat, currentLocation.lng,
                            newLocation.lat, newLocation.lng
                        );
                        
                        if (distance > 50) {
                            currentLocation = newLocation;
                            triggerNewCheckpoint();
                        }
                    } else {
                        currentLocation = newLocation;
                        // First location - trigger immediately
                        setTimeout(() => triggerNewCheckpoint(), 2000);
                    }
                    
                    isLocationEnabled = true;
                },
                function(error) {
                    console.log('Location error, using demo mode');
                    // Demo mode - trigger checkpoint after delay
                    setTimeout(() => triggerNewCheckpoint(), 3000);
                },
                options
            );
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Checkpoint system with real data
        async function triggerNewCheckpoint() {
            // Show loading first
            showScreen('loading-screen');
            
            // Get real location data
            if (currentLocation) {
                try {
                    const realCheckpoint = await getRealLocationInformation(
                        currentLocation.lat, 
                        currentLocation.lng
                    );
                    
                    currentCheckpoint++;
                    
                    // Show checkpoint with real data after loading
                    setTimeout(() => {
                        showCheckpoint(realCheckpoint);
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error creating checkpoint:', error);
                    // Fallback to basic checkpoint
                    const fallback = createFallbackCheckpoint(
                        currentLocation.lat, 
                        currentLocation.lng
                    );
                    currentCheckpoint++;
                    setTimeout(() => {
                        showCheckpoint(fallback);
                    }, 2000);
                }
            } else {
                // Demo mode with fallback
                const fallback = createFallbackCheckpoint(51.5074, -0.1278); // London coords
                currentCheckpoint++;
                setTimeout(() => {
                    showCheckpoint(fallback);
                }, 2000);
            }
        }

        function showCheckpoint(checkpoint) {
            // Store current checkpoint data
            realLocationData = checkpoint;
            
            // Update UI with real data
            document.getElementById('checkpoint-name').textContent = checkpoint.name;
            document.getElementById('location-description').textContent = checkpoint.shortDesc;
            
            showScreen('checkpoint-screen');
            
            // Auto-play audio announcement with real information
            if (audioEnabled) {
                setTimeout(() => {
                    const audioText = `Checkpoint ${currentCheckpoint}! ${checkpoint.shortDesc}`;
                    playAudio(audioText);
                }, 1000);
            }
        }

        // App functions
        window.startApp = function() {
            showScreen('loading-screen');
            
            // Check for audio permission
            if (!audioEnabled) {
                setTimeout(() => {
                    document.getElementById('permission-modal').style.display = 'flex';
                }, 1000);
            }
            
            initializeSpeech();
            startLocationTracking();
        };

        window.enableAudio = function() {
            audioEnabled = true;
            document.getElementById('permission-modal').style.display = 'none';
            
            // Test audio to activate
            const test = new SpeechSynthesisUtterance('Audio enabled');
            test.volume = 0.1;
            test.rate = 2;
            speechSynthesis.speak(test);
        };

        window.skipAudio = function() {
            document.getElementById('permission-modal').style.display = 'none';
        };

        window.playExtraInfo = function() {
            const playBtn = document.getElementById('play-btn');
            
            if (!isPlayingExtra && realLocationData) {
                isPlayingExtra = true;
                playBtn.classList.add('playing');
                
                // Play the real extra information
                playAudio(realLocationData.extraInfo, () => {
                    isPlayingExtra = false;
                    playBtn.classList.remove('playing');
                });
            }
        };

        window.continueExploring = function() {
            showScreen('loading-screen');
            
            // Simulate looking for next location
            setTimeout(() => {
                triggerNewCheckpoint();
            }, 3000);
        };

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeSpeech();
        });
    </script>
</body>
</html>
